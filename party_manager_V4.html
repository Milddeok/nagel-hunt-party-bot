<body>
  <!-- Google Drive ë²„íŠ¼ ì˜ì—­ (ì‚¬ëƒ¥ íŒŒí‹° ë“±ë¡ ì œëª© ìœ„) -->
  <div id="gdrive-area" style="margin-bottom:12px; display:flex; gap:10px; align-items:center;">
    <button id="gdrive-login">Google ë¡œê·¸ì¸</button>
    <button id="gdrive-download">Google Driveì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button id="gdrive-upload">Google Driveë¡œ ì €ì¥í•˜ê¸°</button>
    <span id="gdrive-status" style="margin-left:10px; color:#3e5db3; font-weight:bold;"></span>
  </div>

  <!-- ê¸°ì¡´ ì‚¬ëƒ¥ íŒŒí‹° ë“±ë¡ UI ì‹œì‘ -->
  <h2>ğŸ“… ì‚¬ëƒ¥ íŒŒí‹° ë“±ë¡</h2>
  <!-- ì´í•˜ ê¸°ì¡´ UIë“¤ ê·¸ëŒ€ë¡œ -->
  ...
  
  <!-- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ëë‚˜ê³  êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = '244004129793-4qv5ggmm7hjfqaf51i8t2qbm8jc6bb5i.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyB116zGemMmcg6AsTzIndk-WRSVatokQt0';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = "https://www.googleapis.com/auth/drive.file";
    let GoogleAuth;
    let gDriveFileId = "";

    function updateStatus(msg) {
      document.getElementById("gdrive-status").textContent = msg;
    }

    function initGAPI() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(() => {
          GoogleAuth = gapi.auth2.getAuthInstance();
          updateStatus(GoogleAuth.isSignedIn.get() ? "Google ì¸ì¦ë¨" : "Google ë¡œê·¸ì¸ í•„ìš”");
        });
      });
    }

    document.getElementById("gdrive-login").onclick = () => {
      if (!GoogleAuth) { alert("API ì´ˆê¸°í™” ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤."); return; }
      GoogleAuth.signIn().then(() => updateStatus("Google ì¸ì¦ë¨"));
    };

    document.getElementById("gdrive-download").onclick = async () => {
      if (!GoogleAuth || !GoogleAuth.isSignedIn.get()) { alert("Google ë¡œê·¸ì¸ í•„ìš”"); return; }
      updateStatus("íŒŒì¼ ê²€ìƒ‰ ì¤‘...");
      const res = await gapi.client.drive.files.list({q: "name='party_data.json' and trashed=false"});
      if (!res.result.files.length) { updateStatus("party_data.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"); return; }
      const file = res.result.files[0];
      gDriveFileId = file.id;
      const downloadRes = await gapi.client.drive.files.get({fileId: gDriveFileId, alt: "media"});
      try {
        const obj = JSON.parse(downloadRes.body);
        timetables = obj.timetables || {};
        partyData = obj.partyData || {};
        if(obj.templates){
          document.getElementById("headerTemplateInput").value=obj.templates.header||"";
          document.getElementById("templateInput").value=obj.templates.body||"";
          document.getElementById("footerTemplateInput").value=obj.templates.footer||"";
        }
        if(obj.lastDate){
          document.getElementById("dateInput").value=obj.lastDate;
        }
        saveStorage();
        renderTimetableButtons();
        renderParties();
        updateStatus("party_data.json ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
      } catch(e) {
        updateStatus("party_data.json íŒŒì‹± ì‹¤íŒ¨!");
      }
    };

    document.getElementById("gdrive-upload").onclick = async () => {
      if (!GoogleAuth || !GoogleAuth.isSignedIn.get()) { alert("Google ë¡œê·¸ì¸ í•„ìš”"); return; }
      updateStatus("Google Driveì— ì €ì¥ ì¤‘...");
      const headerTpl = document.getElementById("headerTemplateInput").value;
      const bodyTpl   = document.getElementById("templateInput").value;
      const footerTpl = document.getElementById("footerTemplateInput").value;
      const lastDate  = document.getElementById("dateInput").value;
      const exportObj = { timetables, partyData, templates:{header:headerTpl,body:bodyTpl,footer:footerTpl}, lastDate };
      const content = JSON.stringify(exportObj, null, 2);

      if (gDriveFileId) {
        await gapi.client.request({
          path: `/upload/drive/v3/files/${gDriveFileId}`,
          method: "PATCH",
          params: { uploadType: "media" },
          body: content
        });
        updateStatus("party_data.json ì—…ë°ì´íŠ¸ ì™„ë£Œ!");
      } else {
        const meta = {name:"party_data.json", mimeType:"application/json"};
        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";
        const multipartRequestBody =
          delimiter + 'Content-Type: application/json\r\n\r\n' +
          JSON.stringify(meta) + delimiter +
          'Content-Type: application/json\r\n\r\n' + content + close_delim;
        await gapi.client.request({
          path: '/upload/drive/v3/files',
          method: 'POST',
          params: { uploadType: 'multipart' },
          headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
          body: multipartRequestBody
        });
        updateStatus("party_data.json ìƒˆ íŒŒì¼ë¡œ ì—…ë¡œë“œë¨!");
      }
    };

    window.onload = () => {
      loadStorage();
      renderTimetableButtons();
      ["headerTemplateInput","templateInput","footerTemplateInput"].forEach(id=>{
        const el=document.getElementById(id);
        const key = id==="templateInput"?"bodyTemplate": id==="headerTemplateInput"?"headerTemplate":"footerTemplate";
        el.value = localStorage.getItem(key) || el.value;
        el.addEventListener("input", saveStorage);
      });
      const d=document.getElementById("dateInput");
      d.value = localStorage.getItem("lastDate") || new Date().toISOString().slice(0,10);
      d.addEventListener("change", ()=>{
        localStorage.setItem("lastDate", d.value);
        renderParties();
      });
      jobs.forEach(updateJobInputs);
      renderParties();
      // êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™ ì´ˆê¸°í™”
      initGAPI();
    };
  </script>
</body>
</html>
