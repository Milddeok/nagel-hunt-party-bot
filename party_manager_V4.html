<!-- 기존 코드 상단 <body> 바로 밑에 아래 div 추가 -->
<div id="gdrive-area" style="margin-bottom:20px;">
  <button id="gdrive-login">Google 로그인</button>
  <button id="gdrive-download">Google Drive에서 불러오기</button>
  <button id="gdrive-upload">Google Drive로 저장하기</button>
  <span id="gdrive-status" style="margin-left:10px;color:blue;"></span>
</div>

<!-- 기존 <script> 태그 아래, 제일 마지막에 붙여넣기 -->
<script src="https://apis.google.com/js/api.js"></script>
<script>
const CLIENT_ID = '244004129793-4qv5ggmm7hjfqaf51i8t2qbm8jc6bb5i.apps.googleusercontent.com';
const API_KEY = 'AIzaSyB116zGemMmcg6AsTzIndk-WRSVatokQt0';
const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = "https://www.googleapis.com/auth/drive.file";

let GoogleAuth;
let gDriveFileId = "";

function updateStatus(msg) {
  document.getElementById("gdrive-status").textContent = msg;
}

function initGAPI() {
  gapi.load('client:auth2', () => {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(() => {
      GoogleAuth = gapi.auth2.getAuthInstance();
      updateStatus(GoogleAuth.isSignedIn.get() ? "Google 인증됨" : "Google 로그인이 필요함");
    });
  });
}

document.getElementById("gdrive-login").onclick = () => {
  if (!GoogleAuth) { alert("API 초기화 대기중"); return; }
  GoogleAuth.signIn().then(() => updateStatus("Google 인증됨"));
};

document.getElementById("gdrive-download").onclick = async () => {
  if (!GoogleAuth || !GoogleAuth.isSignedIn.get()) { alert("Google 로그인이 필요합니다"); return; }
  updateStatus("파일 검색 중...");
  const res = await gapi.client.drive.files.list({q: "name='party_data.json' and trashed=false"});
  if (!res.result.files.length) { updateStatus("party_data.json을 찾을 수 없음"); return; }
  const file = res.result.files[0];
  gDriveFileId = file.id;
  const downloadRes = await gapi.client.drive.files.get({fileId: gDriveFileId, alt: "media"});
  try {
    const obj = JSON.parse(downloadRes.body);
    timetables = obj.timetables || {};
    partyData = obj.partyData || {};
    if(obj.templates){
      document.getElementById("headerTemplateInput").value=obj.templates.header||"";
      document.getElementById("templateInput").value=obj.templates.body||"";
      document.getElementById("footerTemplateInput").value=obj.templates.footer||"";
    }
    if(obj.lastDate){
      document.getElementById("dateInput").value=obj.lastDate;
    }
    saveStorage();
    renderTimetableButtons();
    renderParties();
    updateStatus("party_data.json 불러오기 완료!");
  } catch(e) {
    updateStatus("party_data.json 파싱 실패!");
  }
};

document.getElementById("gdrive-upload").onclick = async () => {
  if (!GoogleAuth || !GoogleAuth.isSignedIn.get()) { alert("Google 로그인이 필요합니다"); return; }
  updateStatus("Google Drive에 저장 중...");
  const headerTpl = document.getElementById("headerTemplateInput").value;
  const bodyTpl   = document.getElementById("templateInput").value;
  const footerTpl = document.getElementById("footerTemplateInput").value;
  const lastDate  = document.getElementById("dateInput").value;
  const exportObj = { timetables, partyData, templates:{header:headerTpl,body:bodyTpl,footer:footerTpl}, lastDate };
  const content = JSON.stringify(exportObj, null, 2);

  if (gDriveFileId) {
    await gapi.client.request({
      path: `/upload/drive/v3/files/${gDriveFileId}`,
      method: "PATCH",
      params: { uploadType: "media" },
      body: content
    });
    updateStatus("party_data.json 업데이트 완료!");
  } else {
    const meta = {name:"party_data.json", mimeType:"application/json"};
    const boundary = '-------314159265358979323846';
    const delimiter = "\r\n--" + boundary + "\r\n";
    const close_delim = "\r\n--" + boundary + "--";
    const multipartRequestBody =
      delimiter + 'Content-Type: application/json\r\n\r\n' +
      JSON.stringify(meta) + delimiter +
      'Content-Type: application/json\r\n\r\n' + content + close_delim;
    await gapi.client.request({
      path: '/upload/drive/v3/files',
      method: 'POST',
      params: { uploadType: 'multipart' },
      headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
      body: multipartRequestBody
    });
    updateStatus("party_data.json 새 파일로 업로드됨!");
  }
};

window.onload = function() {
  if(window.loadStorage) loadStorage();
  if(window.renderTimetableButtons) renderTimetableButtons();
  if(window.renderParties) renderParties();
  initGAPI();
};
</script>
