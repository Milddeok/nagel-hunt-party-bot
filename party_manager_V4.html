<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ì‚¬ëƒ¥ íŒŒí‹° ê´€ë¦¬ (í…œí”Œë¦¿ ì¦‰ì‹œ ì ìš©)</title>
  <style>
    body { font-family: sans-serif; margin:20px; display:flex; gap:20px; flex-wrap:wrap; }
    .left, .right { flex:1; min-width:300px; }
    hr { margin:10px 0; }
    .job-row { margin-bottom:12px; }
    .job-row label { display:inline-block; width:50px; }
    .member-inputs input { display:block; margin-bottom:4px; width:60%; padding:4px; }
    button.qty-btn { width:28px; height:28px; }
    textarea { width:100%; margin-bottom:8px; }
    textarea.small { height:60px; }
    .party-entry { border:1px solid #ccc; padding:10px; margin-bottom:10px; white-space:pre-line; }
    .entry-checkbox { margin-right:10px; }
    .action-btn { margin-left:10px; }
    button.copy-btn { margin:4px; }

    /* Google Drive ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #gdrive-area {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      background: none;
      padding: 0;
      border: none;
    }
    #gdrive-area button {
      background: #4666cc;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      padding: 8px 18px;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 2px 6px 0 #0001;
      transition: background 0.2s;
    }
    #gdrive-area button:hover {
      background: #284196;
    }
    #gdrive-status {
      color: #3e5db3;
      font-weight: bold;
      margin-left: 12px;
      min-width: 100px;
    }
    @media (max-width: 900px) {
      body { flex-direction: column; }
      .left, .right { min-width: unset; }
      #gdrive-area { flex-wrap: wrap; }
    }
  </style>
</head>
<body>
  <div class="left">
    <!-- êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë²„íŠ¼: ì‚¬ëƒ¥ íŒŒí‹° ë“±ë¡ ì œëª© ë°”ë¡œ ìœ„ -->
    <div id="gdrive-area">
      <button id="gdrive-login">Google ë¡œê·¸ì¸</button>
      <button id="gdrive-download">Google Driveì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="gdrive-upload">Google Driveë¡œ ì €ì¥í•˜ê¸°</button>
      <span id="gdrive-status"></span>
    </div>

    <h2>ğŸ“… ì‚¬ëƒ¥ íŒŒí‹° ë“±ë¡</h2>
    ë‚ ì§œ: <input type="date" id="dateInput"/><hr>

    <strong>â° íƒ€ì„í…Œì´ë¸” ì„¤ì •</strong><br>
    ì´ë¦„: <input id="timetableName"/>
    ì‹œê°„: <input id="timetableTime" placeholder="ì˜ˆ:16:20~18:20"/><br>
    <button onclick="addTimetable()">â• ì¶”ê°€/ìˆ˜ì •</button>
    <button onclick="deleteTimetable()">ğŸ—‘ ì‚­ì œ</button>
    <div id="timetableButtons"></div><hr>

    <strong>ğŸ‘¥ ì§ì—…ë³„ ì…ë ¥</strong><br>
    <div class="job-row">
      <label>ì „ì‚¬</label>
      ìµœì†Œ:
      <button class="qty-btn" onclick="changeMin('ì „ì‚¬', -1)">âˆ’</button>
      <input type="number" id="ì „ì‚¬-min" value="1" min="0" readonly/>
      <button class="qty-btn" onclick="changeMin('ì „ì‚¬', +1)">ï¼‹</button>
      <div id="ì „ì‚¬-inputs" class="member-inputs"></div>
    </div>
    <div class="job-row">
      <label>ë„ì </label>
      ìµœì†Œ:
      <button class="qty-btn" onclick="changeMin('ë„ì ', -1)">âˆ’</button>
      <input type="number" id="ë„ì -min" value="1" min="0" readonly/>
      <button class="qty-btn" onclick="changeMin('ë„ì ', +1)">ï¼‹</button>
      <div id="ë„ì -inputs" class="member-inputs"></div>
    </div>
    <div class="job-row">
      <label>ë„ê°€</label>
      ìµœì†Œ:
      <button class="qty-btn" onclick="changeMin('ë„ê°€', -1)">âˆ’</button>
      <input type="number" id="ë„ê°€-min" value="1" min="0" readonly/>
      <button class="qty-btn" onclick="changeMin('ë„ê°€', +1)">ï¼‹</button>
      <div id="ë„ê°€-inputs" class="member-inputs"></div>
    </div>
    <div class="job-row">
      <label>ë²•ì‚¬</label>
      ìµœì†Œ:
      <button class="qty-btn" onclick="changeMin('ë²•ì‚¬', -1)">âˆ’</button>
      <input type="number" id="ë²•ì‚¬-min" value="1" min="0" readonly/>
      <button class="qty-btn" onclick="changeMin('ë²•ì‚¬', +1)">ï¼‹</button>
      <div id="ë²•ì‚¬-inputs" class="member-inputs"></div>
    </div>
    <div class="job-row">
      <label>ì§ì</label>
      ìµœì†Œ:
      <button class="qty-btn" onclick="changeMin('ì§ì', -1)">âˆ’</button>
      <input type="number" id="ì§ì-min" value="1" min="0" readonly/>
      <button class="qty-btn" onclick="changeMin('ì§ì', +1)">ï¼‹</button>
      <div id="ì§ì-inputs" class="member-inputs"></div>
    </div>
    <hr>

    <strong>ğŸ“„ í…œí”Œë¦¿ ì„¤ì •</strong><br>
    ë¨¸ë¦¿ê¸€:<br>
    <textarea id="headerTemplateInput" class="small">=== {year}ë…„ {month}ì›” {day}ì¼ ({weekday}) íŒŒí‹° ëª©ë¡ ì‹œì‘ ===</textarea>
    ë³¸ë¬¸:<br>
    <textarea id="templateInput" class="small">ğŸ•’ {time}
ì „ì‚¬: {ì „ì‚¬}
ë„ì : {ë„ì }
ë„ê°€: {ë„ê°€}
ë²•ì‚¬: {ë²•ì‚¬}
ì§ì: {ì§ì}
ì´ ì¸ì›: {total}ëª…
{missing}</textarea>
    ë°”ë‹¥ê¸€:<br>
    <textarea id="footerTemplateInput" class="small">=== íŒŒí‹° ëª©ë¡ ë ===</textarea><br>
    <button onclick="applyTemplates()">í…œí”Œë¦¿ ì ìš©</button>
    <button onclick="registerParty()">âœ… ë“±ë¡</button>
  </div>

  <div class="right">
    <h2>ğŸ“‹ ë“±ë¡ëœ íŒŒí‹° í˜„í™©</h2>
    <button class="copy-btn" onclick="copyAll()">ì „ì²´ ë³µì‚¬</button>
    <button class="copy-btn" onclick="copySelected()">ì„ íƒ ë³µì‚¬</button>
    <textarea id="clipboardPrompt" readonly style="display:none; width:100%; height:60px;"></textarea>
    <div id="partyDisplay"></div>

    <hr>
    <div style="margin:10px 0;">
      <button onclick="downloadData()">ğŸ“¤ íŒŒì¼ ë‚´ë³´ë‚´ê¸°</button>
      <button onclick="triggerFileInput()">ğŸ“¥ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importFromFile(event)"/>
    </div>
  </div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const jobs = ["ì „ì‚¬","ë„ì ","ë„ê°€","ë²•ì‚¬","ì§ì"];
    let timetables = {}, partyData = {};
    const defaultTables = {
      "1-1":"09:00~11:00","1-2":"11:20~13:20","1-3":"14:00~16:00",
      "2-1":"16:20~18:20","2-2":"19:00~21:00","2-3":"21:10~21:40","2-4":"23:05~24:05"
    };

    function loadStorage(){
      timetables = JSON.parse(localStorage.getItem("timetables")||"null") || {...defaultTables};
      partyData  = JSON.parse(localStorage.getItem("partyData")||"{}");
    }
    function saveStorage(){
      localStorage.setItem("timetables", JSON.stringify(timetables));
      localStorage.setItem("partyData",  JSON.stringify(partyData));
      localStorage.setItem("headerTemplate", document.getElementById("headerTemplateInput").value);
      localStorage.setItem("bodyTemplate",   document.getElementById("templateInput").value);
      localStorage.setItem("footerTemplate", document.getElementById("footerTemplateInput").value);
    }

    function renderTimetableButtons(){
      const box = document.getElementById("timetableButtons");
      box.innerHTML = "";
      Object.keys(timetables).sort().forEach(n => {
        const b = document.createElement("button");
        b.textContent = `${n} (${timetables[n]})`;
        b.onclick = ()=>selectTimetable(n);
        box.appendChild(b);
      });
    }

    function addTimetable(){
      const n = document.getElementById("timetableName").value.trim();
      const t = document.getElementById("timetableTime").value.trim();
      if(!n||!t) return alert("ì´ë¦„Â·ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      timetables[n] = t; saveStorage(); renderTimetableButtons();
      document.getElementById("timetableName").value = "";
      document.getElementById("timetableTime").value = "";
    }

    function deleteTimetable(){
      const n = document.getElementById("timetableName").value.trim();
      if(!timetables[n]) return alert("ì‚­ì œí•  íƒ€ì„í…Œì´ë¸”ì„ ì„ íƒí•˜ì„¸ìš”.");
      if(confirm(`${n} ì‚­ì œí• ê¹Œìš”?`)){
        delete timetables[n]; saveStorage(); renderTimetableButtons();
        document.getElementById("timetableName").value = "";
        document.getElementById("timetableTime").value = "";
      }
    }

    function selectTimetable(n){
      document.getElementById("timetableName").value = n;
      document.getElementById("timetableTime").value = timetables[n];
      const date = document.getElementById("dateInput").value;
      if(partyData[date] && partyData[date][n]){
        const d = partyData[date][n];
        jobs.forEach(job => {
          document.getElementById(`${job}-min`).value = d.mins[job];
          updateJobInputs(job);
          d.roles[job].forEach((v,i) => {
            const inp = document.getElementById(`${job}-member-${i}`);
            if(inp) inp.value = v;
          });
        });
      }
    }

    function changeMin(job, delta){
      const inp = document.getElementById(`${job}-min`);
      let v = parseInt(inp.value,10)||0;
      v = Math.max(0, v + delta);
      inp.value = v;
      updateJobInputs(job);
    }

    function updateJobInputs(job){
      const min = parseInt(document.getElementById(`${job}-min`).value,10)||0;
      const cont = document.getElementById(`${job}-inputs`);
      const old = Array.from(cont.querySelectorAll("input")).map(i=>i.value);
      cont.innerHTML = "";
      for(let i=0; i<min; i++){
        const inp = document.createElement("input");
        inp.type = "text";
        inp.id = `${job}-member-${i}`;
        inp.placeholder = `${job} ì´ë¦„ ${i+1}`;
        if(old[i]!==undefined) inp.value = old[i];
        cont.appendChild(inp);
      }
    }

    function registerParty(){
      const date = document.getElementById("dateInput").value;
      const slot = document.getElementById("timetableName").value.trim();
      const time = document.getElementById("timetableTime").value.trim();
      if(!date||!slot||!time) return alert("ë‚ ì§œÂ·ì´ë¦„Â·ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

      const data = { time, roles:{}, mins:{}, total:0, missing:[] };
      jobs.forEach(job => {
        const min = parseInt(document.getElementById(`${job}-min`).value,10)||0;
        const arr = [];
        for(let i=0; i<min; i++){
          arr.push(document.getElementById(`${job}-member-${i}`).value.trim());
        }
        data.roles[job] = arr;
        data.mins[job] = min;
        const cnt = arr.filter(x=>x).length;
        data.total += cnt;
        if(cnt < min) data.missing.push(`${job} (${cnt}/${min})`);
      });

      if(!partyData[date]) partyData[date] = {};
      partyData[date][slot] = data;
      saveStorage();
      renderParties();
    }

    function deleteParty(date, slot){
      if(confirm(`${date} ${slot} íŒŒí‹° ì‚­ì œ?`)){
        delete partyData[date][slot];
        saveStorage();
        renderParties();
      }
    }

    function renderParties(){
      const cont = document.getElementById("partyDisplay");
      cont.innerHTML = "";
      const date = document.getElementById("dateInput").value;
      if(!date || !partyData[date]) {
        cont.innerText = "ë“±ë¡ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const [y,mo,day] = date.split("-");
      const dow = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][new Date(date).getDay()];
      let hTpl = document.getElementById("headerTemplateInput").value;
      hTpl = hTpl.replace("{year}", y).replace("{month}", mo).replace("{day}", day).replace("{weekday}", dow);
      cont.insertAdjacentHTML("beforeend", `<div class="party-entry">${hTpl}</div><hr>`);

      Object.keys(partyData[date]).sort().forEach(slot => {
        const d = partyData[date][slot];
        let bTpl = document.getElementById("templateInput").value;
        bTpl = bTpl.replace("{time}", `${slot} ${d.time}`);
        jobs.forEach(job => {
          const disp = d.roles[job].map(n=> n ? `[${n}]` : "[ ]").join("");
          bTpl = bTpl.replace(`{${job}}`, disp);
        });
        bTpl = bTpl.replace("{total}", d.total)
                   .replace("{missing}", d.missing.length? `#ë ${d.missing.join(", ")}` : "#ì™„ë¹„");

        cont.insertAdjacentHTML("beforeend",
          `<div class="party-entry">\
             <input type="checkbox" class="entry-checkbox" checked>\
             <span class="entry-content">${bTpl.replace(/\n/g,"<br>")}</span>\
             <button class="action-btn" onclick="deleteParty('${date}','${slot}')">ì‚­ì œ</button>\
           </div><hr>`
        );
      });

      let fTpl = document.getElementById("footerTemplateInput").value;
      fTpl = fTpl.replace("{year}", y).replace("{month}", mo).replace("{day}", day).replace("{weekday}", dow);
      cont.insertAdjacentHTML("beforeend", `<div class="party-entry">${fTpl}</div>`);

      renderTimetableButtons();
    }

    function applyTemplates() {
      saveStorage();
      renderParties();
      alert("âœ… í…œí”Œë¦¿ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function copyAll(){
      const lines = Array.from(document.querySelectorAll(".party-entry"))
        .map(div=>{
          const span = div.querySelector(".entry-content");
          return span? span.innerText.trim(): div.innerText.trim();
        }).filter(t=>t);
      const txt = lines.join("\n");
      if(!txt) return alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
      navigator.clipboard.writeText(txt).catch(()=>{
        const ta=document.getElementById("clipboardPrompt");
        ta.value=txt; ta.style.display="block"; ta.select();
        alert("í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.");
      });
    }

    function copySelected(){
      const divs = Array.from(document.querySelectorAll(".party-entry"));
      if(divs.length<2) return alert("ë“±ë¡ëœ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.");
      const header = divs[0].innerText.trim();
      const footer = divs[divs.length-1].innerText.trim();
      const body = Array.from(document.querySelectorAll(".entry-checkbox"))
        .filter(cb=>cb.checked)
        .map(cb=>cb.parentElement.querySelector(".entry-content").innerText.trim())
        .filter(t=>t);
      if(body.length===0) return alert("ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
      const txt = [header,...body,footer].join("\n");
      navigator.clipboard.writeText(txt).catch(()=>{
        const ta=document.getElementById("clipboardPrompt");
        ta.value=txt; ta.style.display="block"; ta.select();
        alert("í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.");
      });
    }

    function downloadData(){
      const headerTpl = document.getElementById("headerTemplateInput").value;
      const bodyTpl   = document.getElementById("templateInput").value;
      const footerTpl = document.getElementById("footerTemplateInput").value;
      const lastDate  = document.getElementById("dateInput").value;

      const exportObj = { timetables, partyData, templates:{header:headerTpl,body:bodyTpl,footer:footerTpl}, lastDate };
      const str = JSON.stringify(exportObj,null,2);
      const blob = new Blob([str], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download=`party_data_${new Date().toISOString().slice(0,10)}.json`;
      document.body.append(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function triggerFileInput(){ document.getElementById("importFile").click(); }

    function importFromFile(evt){
      const file=evt.target.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=e=>{
        try{
          const obj=JSON.parse(e.target.result);
          timetables=obj.timetables||{};
          partyData=obj.partyData||{};
          if(obj.templates){
            document.getElementById("headerTemplateInput").value=obj.templates.header||"";
            document.getElementById("templateInput").value=obj.templates.body||"";
            document.getElementById("footerTemplateInput").value=obj.templates.footer||"";
          }
          if(obj.lastDate){
            document.getElementById("dateInput").value=obj.lastDate;
          }
          saveStorage();
          alert("âœ… íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤.");
          renderTimetableButtons();
          renderParties();
        }catch{
          alert("â— ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
        }
      };
      reader.readAsText(file);
    }

    // êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ê´€ë ¨ ì½”ë“œ
    const CLIENT_ID = '244004129793-4qv5ggmm7hjfqaf51i8t2qbm8jc6bb5i.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyB116zGemMmcg6AsTzIndk-WRSVatokQt0';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = "https://www.googleapis.com/auth/drive.file";
    let GoogleAuth;
    let gDriveFileId = "";

    function updateStatus(msg) {
      document.getElementById("gdrive-status").textContent = msg;
    }

    function initGAPI() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(() => {
          GoogleAuth = gapi.auth2.getAuthInstance();
          updateStatus(GoogleAuth.isSignedIn.get() ? "Google ì¸ì¦ë¨" : "Google ë¡œê·¸ì¸ í•„ìš”");
        });
      });
    }

    document.getElementById("gdrive-login").onclick = () => {
      if (!GoogleAuth) { alert("API ì´ˆê¸°í™” ëŒ€ê¸°ì¤‘ì…ë‹ˆë‹¤."); return; }
      GoogleAuth.signIn().then(() => updateStatus("Google ì¸ì¦ë¨"));
    };

    document.getElementById("gdrive-download").onclick = async () => {
      if (!GoogleAuth || !GoogleAuth.isSignedIn.get()) { alert("Google ë¡œê·¸ì¸ í•„ìš”"); return; }
      updateStatus("íŒŒì¼ ê²€ìƒ‰ ì¤‘...");
      const res = await gapi.client.drive.files.list({q: "name='party_data.json' and trashed=false"});
      if (!res.result.files.length) { updateStatus("party_data.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"); return; }
      const file = res.result.files[0];
      gDriveFileId = file.id;
      const downloadRes = await gapi.client.drive.files.get({fileId: gDriveFileId, alt: "media"});
      try {
        const obj = JSON.parse(downloadRes.body);
        timetables = obj.timetables || {};
        partyData = obj.partyData || {};
        if(obj.templates){
          document.getElementById("headerTemplateInput").value=obj.templates.header||"";
          document.getElementById("templateInput").value=obj.templates.body||"";
          document.getElementById("footerTemplateInput").value=obj.templates.footer||"";
        }
        if(obj.lastDate){
          document.getElementById("dateInput").value=obj.lastDate;
        }
        saveStorage();
        renderTimetableButtons();
        renderParties();
        updateStatus("party_data.json ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
      } catch(e) {
        updateStatus("party_data.json íŒŒì‹± ì‹¤íŒ¨!");
      }
    };

    document.getElementById("gdrive-upload").onclick = async () => {
      if (!GoogleAuth || !GoogleAuth.isSignedIn.get()) { alert("Google ë¡œê·¸ì¸ í•„ìš”"); return; }
      updateStatus("Google Driveì— ì €ì¥ ì¤‘...");
      const headerTpl = document.getElementById("headerTemplateInput").value;
      const bodyTpl   = document.getElementById("templateInput").value;
      const footerTpl = document.getElementById("footerTemplateInput").value;
      const lastDate  = document.getElementById("dateInput").value;
      const exportObj = { timetables, partyData, templates:{header:headerTpl,body:bodyTpl,footer:footerTpl}, lastDate };
      const content = JSON.stringify(exportObj, null, 2);

      if (gDriveFileId) {
        await gapi.client.request({
          path: `/upload/drive/v3/files/${gDriveFileId}`,
          method: "PATCH",
          params: { uploadType: "media" },
          body: content
        });
        updateStatus("party_data.json ì—…ë°ì´íŠ¸ ì™„ë£Œ!");
      } else {
        const meta = {name:"party_data.json", mimeType:"application/json"};
        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";
        const multipartRequestBody =
          delimiter + 'Content-Type: application/json\r\n\r\n' +
          JSON.stringify(meta) + delimiter +
          'Content-Type: application/json\r\n\r\n' + content + close_delim;
        await gapi.client.request({
          path: '/upload/drive/v3/files',
          method: 'POST',
          params: { uploadType: 'multipart' },
          headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
          body: multipartRequestBody
        });
        updateStatus("party_data.json ìƒˆ íŒŒì¼ë¡œ ì—…ë¡œë“œë¨!");
      }
    };

    window.onload = () => {
      loadStorage();
      renderTimetableButtons();
      ["headerTemplateInput","templateInput","footerTemplateInput"].forEach(id=>{
        const el=document.getElementById(id);
        const key = id==="templateInput"?"bodyTemplate": id==="headerTemplateInput"?"headerTemplate":"footerTemplate";
        el.value = localStorage.getItem(key) || el.value;
        el.addEventListener("input", saveStorage);
      });
      const d=document.getElementById("dateInput");
      d.value = localStorage.getItem("lastDate") || new Date().toISOString().slice(0,10);
      d.addEventListener("change", ()=>{
        localStorage.setItem("lastDate", d.value);
        renderParties();
      });
      jobs.forEach(updateJobInputs);
      renderParties();
      initGAPI();
    };
  </script>
</body>
</html>
